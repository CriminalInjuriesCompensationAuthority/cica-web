"use strict";

require("core-js/modules/es.symbol.description.js");

require("core-js/modules/es.symbol.async-iterator.js");

require("core-js/modules/es.symbol.match-all.js");

require("core-js/modules/es.aggregate-error.js");

require("core-js/modules/es.array.flat.js");

require("core-js/modules/es.array.flat-map.js");

require("core-js/modules/es.array.index-of.js");

require("core-js/modules/es.array.last-index-of.js");

require("core-js/modules/es.array.reverse.js");

require("core-js/modules/es.array.slice.js");

require("core-js/modules/es.array.sort.js");

require("core-js/modules/es.array.splice.js");

require("core-js/modules/es.array.unscopables.flat.js");

require("core-js/modules/es.array.unscopables.flat-map.js");

require("core-js/modules/es.array-buffer.constructor.js");

require("core-js/modules/es.array-buffer.slice.js");

require("core-js/modules/es.global-this.js");

require("core-js/modules/es.json.stringify.js");

require("core-js/modules/es.number.parse-float.js");

require("core-js/modules/es.object.entries.js");

require("core-js/modules/es.object.from-entries.js");

require("core-js/modules/es.object.values.js");

require("core-js/modules/es.promise.js");

require("core-js/modules/es.promise.all-settled.js");

require("core-js/modules/es.promise.any.js");

require("core-js/modules/es.promise.finally.js");

require("core-js/modules/es.reflect.to-string-tag.js");

require("core-js/modules/es.string.match-all.js");

require("core-js/modules/es.string.pad-end.js");

require("core-js/modules/es.string.pad-start.js");

require("core-js/modules/es.string.replace.js");

require("core-js/modules/es.string.replace-all.js");

require("core-js/modules/es.string.trim.js");

require("core-js/modules/es.string.trim-end.js");

require("core-js/modules/es.string.trim-start.js");

require("core-js/modules/es.typed-array.float32-array.js");

require("core-js/modules/es.typed-array.float64-array.js");

require("core-js/modules/es.typed-array.int8-array.js");

require("core-js/modules/es.typed-array.int16-array.js");

require("core-js/modules/es.typed-array.int32-array.js");

require("core-js/modules/es.typed-array.uint8-array.js");

require("core-js/modules/es.typed-array.uint8-clamped-array.js");

require("core-js/modules/es.typed-array.uint16-array.js");

require("core-js/modules/es.typed-array.uint32-array.js");

require("core-js/modules/es.typed-array.from.js");

require("core-js/modules/es.typed-array.of.js");

require("core-js/modules/esnext.aggregate-error.js");

require("core-js/modules/esnext.array.at.js");

require("core-js/modules/esnext.array.filter-out.js");

require("core-js/modules/esnext.array.is-template-object.js");

require("core-js/modules/esnext.array.last-index.js");

require("core-js/modules/esnext.array.last-item.js");

require("core-js/modules/esnext.array.unique-by.js");

require("core-js/modules/esnext.async-iterator.constructor.js");

require("core-js/modules/esnext.async-iterator.as-indexed-pairs.js");

require("core-js/modules/esnext.async-iterator.drop.js");

require("core-js/modules/esnext.async-iterator.every.js");

require("core-js/modules/esnext.async-iterator.filter.js");

require("core-js/modules/esnext.async-iterator.find.js");

require("core-js/modules/esnext.async-iterator.flat-map.js");

require("core-js/modules/esnext.async-iterator.for-each.js");

require("core-js/modules/esnext.async-iterator.from.js");

require("core-js/modules/esnext.async-iterator.map.js");

require("core-js/modules/esnext.async-iterator.reduce.js");

require("core-js/modules/esnext.async-iterator.some.js");

require("core-js/modules/esnext.async-iterator.take.js");

require("core-js/modules/esnext.async-iterator.to-array.js");

require("core-js/modules/esnext.bigint.range.js");

require("core-js/modules/esnext.composite-key.js");

require("core-js/modules/esnext.composite-symbol.js");

require("core-js/modules/esnext.global-this.js");

require("core-js/modules/esnext.iterator.constructor.js");

require("core-js/modules/esnext.iterator.as-indexed-pairs.js");

require("core-js/modules/esnext.iterator.drop.js");

require("core-js/modules/esnext.iterator.every.js");

require("core-js/modules/esnext.iterator.filter.js");

require("core-js/modules/esnext.iterator.find.js");

require("core-js/modules/esnext.iterator.flat-map.js");

require("core-js/modules/esnext.iterator.for-each.js");

require("core-js/modules/esnext.iterator.from.js");

require("core-js/modules/esnext.iterator.map.js");

require("core-js/modules/esnext.iterator.reduce.js");

require("core-js/modules/esnext.iterator.some.js");

require("core-js/modules/esnext.iterator.take.js");

require("core-js/modules/esnext.iterator.to-array.js");

require("core-js/modules/esnext.map.delete-all.js");

require("core-js/modules/esnext.map.emplace.js");

require("core-js/modules/esnext.map.every.js");

require("core-js/modules/esnext.map.filter.js");

require("core-js/modules/esnext.map.find.js");

require("core-js/modules/esnext.map.find-key.js");

require("core-js/modules/esnext.map.from.js");

require("core-js/modules/esnext.map.group-by.js");

require("core-js/modules/esnext.map.includes.js");

require("core-js/modules/esnext.map.key-by.js");

require("core-js/modules/esnext.map.key-of.js");

require("core-js/modules/esnext.map.map-keys.js");

require("core-js/modules/esnext.map.map-values.js");

require("core-js/modules/esnext.map.merge.js");

require("core-js/modules/esnext.map.of.js");

require("core-js/modules/esnext.map.reduce.js");

require("core-js/modules/esnext.map.some.js");

require("core-js/modules/esnext.map.update.js");

require("core-js/modules/esnext.map.update-or-insert.js");

require("core-js/modules/esnext.map.upsert.js");

require("core-js/modules/esnext.math.clamp.js");

require("core-js/modules/esnext.math.deg-per-rad.js");

require("core-js/modules/esnext.math.degrees.js");

require("core-js/modules/esnext.math.fscale.js");

require("core-js/modules/esnext.math.iaddh.js");

require("core-js/modules/esnext.math.imulh.js");

require("core-js/modules/esnext.math.isubh.js");

require("core-js/modules/esnext.math.rad-per-deg.js");

require("core-js/modules/esnext.math.radians.js");

require("core-js/modules/esnext.math.scale.js");

require("core-js/modules/esnext.math.seeded-prng.js");

require("core-js/modules/esnext.math.signbit.js");

require("core-js/modules/esnext.math.umulh.js");

require("core-js/modules/esnext.number.from-string.js");

require("core-js/modules/esnext.number.range.js");

require("core-js/modules/esnext.object.iterate-entries.js");

require("core-js/modules/esnext.object.iterate-keys.js");

require("core-js/modules/esnext.object.iterate-values.js");

require("core-js/modules/esnext.observable.js");

require("core-js/modules/esnext.promise.all-settled.js");

require("core-js/modules/esnext.promise.any.js");

require("core-js/modules/esnext.promise.try.js");

require("core-js/modules/esnext.reflect.define-metadata.js");

require("core-js/modules/esnext.reflect.delete-metadata.js");

require("core-js/modules/esnext.reflect.get-metadata.js");

require("core-js/modules/esnext.reflect.get-metadata-keys.js");

require("core-js/modules/esnext.reflect.get-own-metadata.js");

require("core-js/modules/esnext.reflect.get-own-metadata-keys.js");

require("core-js/modules/esnext.reflect.has-metadata.js");

require("core-js/modules/esnext.reflect.has-own-metadata.js");

require("core-js/modules/esnext.reflect.metadata.js");

require("core-js/modules/esnext.set.add-all.js");

require("core-js/modules/esnext.set.delete-all.js");

require("core-js/modules/esnext.set.difference.js");

require("core-js/modules/esnext.set.every.js");

require("core-js/modules/esnext.set.filter.js");

require("core-js/modules/esnext.set.find.js");

require("core-js/modules/esnext.set.from.js");

require("core-js/modules/esnext.set.intersection.js");

require("core-js/modules/esnext.set.is-disjoint-from.js");

require("core-js/modules/esnext.set.is-subset-of.js");

require("core-js/modules/esnext.set.is-superset-of.js");

require("core-js/modules/esnext.set.join.js");

require("core-js/modules/esnext.set.map.js");

require("core-js/modules/esnext.set.of.js");

require("core-js/modules/esnext.set.reduce.js");

require("core-js/modules/esnext.set.some.js");

require("core-js/modules/esnext.set.symmetric-difference.js");

require("core-js/modules/esnext.set.union.js");

require("core-js/modules/esnext.string.at.js");

require("core-js/modules/esnext.string.code-points.js");

require("core-js/modules/esnext.string.match-all.js");

require("core-js/modules/esnext.string.replace-all.js");

require("core-js/modules/esnext.symbol.async-dispose.js");

require("core-js/modules/esnext.symbol.dispose.js");

require("core-js/modules/esnext.symbol.observable.js");

require("core-js/modules/esnext.symbol.pattern-match.js");

require("core-js/modules/esnext.symbol.replace-all.js");

require("core-js/modules/esnext.typed-array.at.js");

require("core-js/modules/esnext.typed-array.filter-out.js");

require("core-js/modules/esnext.weak-map.delete-all.js");

require("core-js/modules/esnext.weak-map.from.js");

require("core-js/modules/esnext.weak-map.of.js");

require("core-js/modules/esnext.weak-map.emplace.js");

require("core-js/modules/esnext.weak-map.upsert.js");

require("core-js/modules/esnext.weak-set.add-all.js");

require("core-js/modules/esnext.weak-set.delete-all.js");

require("core-js/modules/esnext.weak-set.from.js");

require("core-js/modules/esnext.weak-set.of.js");

require("core-js/modules/web.dom-collections.iterator.js");

require("core-js/modules/web.immediate.js");

require("core-js/modules/web.queue-microtask.js");

require("core-js/modules/web.url.js");

require("core-js/modules/web.url.to-json.js");

require("core-js/modules/web.url-search-params.js");

var axios = _interopRequireWildcard(require("axios"));

var jsCookies = _interopRequireWildcard(require("js-cookie"));

var _ga = _interopRequireDefault(require("../modules/ga"));

var _autocomplete = _interopRequireDefault(require("../modules/autocomplete/autocomplete"));

var _cookieBanner = _interopRequireDefault(require("../modules/cookie-banner"));

var _cookiePreference = _interopRequireDefault(require("../modules/cookie-preference"));

var _modalTimeout = _interopRequireDefault(require("../modules/modal-timeout"));

var _newWindowAnchors = _interopRequireDefault(require("../modules/new-window-anchors"));

var _liveChat = _interopRequireDefault(require("../modules/live-chat"));

var _postcodeLookup = _interopRequireDefault(require("../modules/postcode-lookup"));

var _msToMinutesAndSeconds = _interopRequireDefault(require("../modules/modal-timeout/utils/msToMinutesAndSeconds"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

(() => {
  var cookiePreference = (0, _cookiePreference.default)('_prefs', ['essential', 'analytics']);

  if (cookiePreference.get('analytics').value === '1') {
    var cicaGa = (0, _ga.default)(window);
    cicaGa.init();
  } else {
    window["ga-disable-".concat(window.CICA.ANALYTICS_TRACKING_ID)] = true;
  }

  var autocomplete = (0, _autocomplete.default)(window);
  autocomplete.init('.govuk-select');
  var postcodeLookup = (0, _postcodeLookup.default)(window);
  postcodeLookup.init();
  var cookieBanner = (0, _cookieBanner.default)(window, cookiePreference, {
    cookieBannerElement: '#cookie-banner',
    cookieBannerVisibleClass: 'cookie-banner--visible',
    cookieBannerButtonAcceptAll: '#cookie-banner-accept-all'
  });
  cookieBanner.show();
  /* ****************************************** */

  /* ** MODAL + TIMEOUT IMPLEMENTATION START ** */

  /* ****************************************** */

  function modalTimout() {
    return _modalTimout.apply(this, arguments);
  }

  function _modalTimout() {
    _modalTimout = _asyncToGenerator(function* () {
      var modalElements = window.document.querySelectorAll('[data-module~="govuk-modal"]');
      var sessionEndedModal;
      var errorModal;
      var sessionTimingOutModal; // const SESSION_DURATION_BUFFER = 30000;

      var sessionData;
      var eventHandlers = {};
      var documentVisible = true;

      function refreshSessionAndModalTimeout() {
        return _refreshSessionAndModalTimeout.apply(this, arguments);
      }

      function _refreshSessionAndModalTimeout() {
        _refreshSessionAndModalTimeout = _asyncToGenerator(function* () {
          var response = yield axios.get('/session/keep-alive');
          sessionData = response.data.data[0].attributes;
          sessionTimingOutModal.close();
          sessionTimingOutModal.refresh({
            startTime: sessionData.created
          });
        });
        return _refreshSessionAndModalTimeout.apply(this, arguments);
      }

      function getSessionData() {
        return JSON.parse(jsCookies.get('sessionExpiry') || '{}');
      }

      function checkShouldOpenModal() {
        if (documentVisible && // session hasn't already ended. Avoids the modal opening
        // when a user blurs and focuses a tab after the session
        // has ended.
        Date.now() < sessionData.expires && // session is nearing its end.
        sessionTimingOutModal.timer.timeRemaining < sessionData.duration / 6) {
          sessionTimingOutModal.open();
        }
      }

      if (modalElements.length) {
        window.document.addEventListener('visibilitychange', () => {
          documentVisible = window.document.visibilityState === 'visible';

          if (documentVisible) {
            sessionData = getSessionData();
            checkShouldOpenModal();
          }
        });
        sessionData = getSessionData(); // haven't hit `/apply` yet.

        if (!sessionData) {
          return;
        }

        if (modalElements.length) {
          var TimeoutModal = (0, _modalTimeout.default)(window);
          sessionEndedModal = new TimeoutModal({
            element: '#govuk-modal-session-ended',
            closeElement: '.govuk-modal__close',
            onOpen: () => {
              window.gtag('event', 'open', {
                event_category: 'govuk-modal-session-ended',
                non_interaction: true
              });
            }
          });
          errorModal = new TimeoutModal({
            element: '#govuk-modal-session-resume-error',
            closeElement: '.govuk-modal__close',
            onOpen: () => {
              window.gtag('event', 'open', {
                event_category: '#govuk-modal-session-resume-error',
                non_interaction: true
              });
            }
          });
          sessionTimingOutModal = new TimeoutModal({
            element: '#govuk-modal-session-timing-out',
            resumeElement: '.govuk-modal__continue',
            // openIn: Math.floor((sessionData.duration * (1 / 4)) / 1000) * 1000,
            onBeforeOpen: () => {
              // if a user opens a new tab with another instance of `/apply` the
              // session will have been refreshed. Because of this the timeout modal
              // will open prematurely due to it working from a previously-set session
              // update date. check if the timers end time is less than the actual
              // session end time and calibrate the timeout to open the modal
              // accordingly.
              sessionData = getSessionData();
              var expectedEndTime = sessionTimingOutModal.timer.endTime;
              var actualEndTime = sessionData.expires;

              if (expectedEndTime < actualEndTime) {
                var now = Date.now();
                sessionTimingOutModal.close();
                sessionTimingOutModal.refresh({
                  startTime: now,
                  duration: sessionData.expires - now
                });
                return false;
              }

              return true;
            },
            onOpen: () => {
              window.gtag('event', 'open', {
                event_category: 'govuk-modal-session-timing-out',
                non_interaction: true
              });

              if (!eventHandlers.onOpenResumeElement) {
                var resumeElement = sessionTimingOutModal.config.element.querySelector('.govuk-modal__continue');
                eventHandlers.onOpenResumeElement = {
                  element: resumeElement,
                  handler: e => {
                    e.preventDefault();
                    refreshSessionAndModalTimeout().catch(() => {
                      errorModal.open();
                    });
                  }
                };
              }

              eventHandlers.onOpenResumeElement.element.addEventListener('click', eventHandlers.onOpenResumeElement.handler);
            },
            onClose: () => {
              eventHandlers.onOpenResumeElement.element.removeEventListener('click', eventHandlers.onOpenResumeElement.handler);
            },
            timer: {
              duration: sessionData.duration,
              startTime: new Date(sessionData.created) * 1,
              interval: 700,
              onTick: timeRemaining => {
                if (!documentVisible) {
                  return;
                } // https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Live_Regions
                // aria-live="assertive" is an attribute of the span that contains the time remaining.
                // Only update the DOM when the modal is actually visible. This will prevent screen
                // readers from announcing every single DOM update that happens in the "background".


                if (sessionTimingOutModal.isOpen) {
                  sessionTimingOutModal.content(title => {
                    var titleElement = title;
                    var timeRemainingElement = titleElement.querySelector('.govuk-modal__time-remaining');
                    timeRemainingElement.innerHTML = (0, _msToMinutesAndSeconds.default)(timeRemaining);
                  });
                }

                checkShouldOpenModal();
              },
              onEnd: () => {
                sessionTimingOutModal.close();
                sessionEndedModal.open();
              }
            }
          });
          var textAreaElements = window.document.querySelectorAll('.govuk-textarea');
          textAreaElements.forEach(element => {
            element.addEventListener('paste', () => {
              refreshSessionAndModalTimeout();
            }, false);
            element.addEventListener('input', () => {
              var now = new Date() * 1; // if there is less than half the session length left when a user
              // updates a textarea, then refresh the session.

              if (now > new Date(sessionData.expires) * 1 - sessionData.duration / 2) {
                refreshSessionAndModalTimeout();
              }
            }, false);
          });
        }
      }
    });
    return _modalTimout.apply(this, arguments);
  }

  modalTimout();
  /* ****************************************** */

  /* ** MODAL + TIMEOUT IMPLEMENTATION END   ** */

  /* ****************************************** */

  (0, _newWindowAnchors.default)(window.document.querySelectorAll('[open-new-window]'));
  (0, _liveChat.default)(window.document.querySelector('#chat-iframe'));
})();
